<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>GPT ë¼ì´ì„ ìŠ¤ ì¸ì¦</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      padding: 2rem;
      max-width: 480px;
      margin: auto;
      text-align: center;
    }
    h1 { margin-bottom: 1rem; }
    .step { margin: 1rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 12px; }
    input, button {
      padding: .7rem 1rem; border-radius: 8px; border: 1px solid #ccc; width: 100%; margin-top: .5rem;
    }
    button {
      background: #4CAF50; color: white; cursor: pointer; border: none; font-size: 1rem;
    }
    button:disabled { background: #aaa; cursor: not-allowed; }
    button:hover:enabled { background: #45a049; }
    #status { margin-top: 1rem; font-weight: bold; white-space: pre-line; }
    #closeBtn { display: none; margin-top: 1rem; background: #f44336; }
  </style>
</head>
<body>
  <h1>GPT ë¼ì´ì„ ìŠ¤ ì¸ì¦</h1>

  <!-- Step 1 -->
  <div class="step">
    <label>ë¼ì´ì„ ìŠ¤ í‚¤</label>
    <input type="text" id="licenseKey" placeholder="êµ¬ë§¤ í›„ ë°›ì€ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
    <button onclick="checkLicense()">1. í‚¤ í™•ì¸</button>
  </div>

  <!-- Step 2 -->
  <div class="step">
    <button id="loginBtn" onclick="loginWithGoogle()" disabled>2. Google ë¡œê·¸ì¸</button>
  </div>

  <p id="status"></p>
  <button id="closeBtn" onclick="window.close()">âŒ ì°½ ë‹«ê¸°</button>

  <script>
    const SUPABASE_URL = "https://kwjxtfyzerwynwqnbpjk.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3anh0Znl6ZXJ3eW53cW5icGprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNzUyOTAsImV4cCI6MjA3Mzc1MTI5MH0.ykrO0pTt6dK56pXPmvcnNdWSm894n1tvNPMvE4ZbgwI"; // ğŸ”‘ ì‹¤ì œ anon í‚¤ë¡œ êµì²´
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentLicenseKey = "";
    let licenseKeyValid = false; // âœ… í‚¤ ê²€ì¦ ì„±ê³µ ì—¬ë¶€

    // 1. ë¼ì´ì„ ìŠ¤ í‚¤ í™•ì¸
    async function checkLicense() {
      const key = document.getElementById("licenseKey").value.trim();
      if (!key) return setStatus("âŒ í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      const res = await fetch(`${SUPABASE_URL}/functions/v1/license-precheck`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "apikey": SUPABASE_ANON_KEY },
        body: JSON.stringify({ license_key: key })
      });
      const data = await res.json();
      if (data.valid) {
        currentLicenseKey = key;
        licenseKeyValid = true;
        localStorage.setItem("licenseKey", key);
        localStorage.setItem("licenseKeyValid", "true");
        document.getElementById("loginBtn").disabled = false;
        setStatus("âœ… í‚¤ í™•ì¸ ì™„ë£Œ! ì´ì œ ë¡œê·¸ì¸í•˜ì„¸ìš”.");
      } else {
        licenseKeyValid = false;
        localStorage.setItem("licenseKeyValid", "false");
        document.getElementById("loginBtn").disabled = true;
        setStatus("âŒ ì˜¬ë°”ë¥¸ ë¼ì´ì„ ìŠ¤ í‚¤ê°€ ì•„ë‹™ë‹ˆë‹¤.");
      }
    }

    // 2. Google ë¡œê·¸ì¸
    async function loginWithGoogle() {
      if (!licenseKeyValid) {
        return setStatus("âŒ ë¨¼ì € ì˜¬ë°”ë¥¸ ë¼ì´ì„ ìŠ¤ í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
      }
      const { error } = await supabase.auth.signInWithOAuth({
        provider: "google",
        options: { 
          redirectTo: "https://momooo416.github.io/gpt-login-page/license-login.html"
        }
      });
      if (error) setStatus("âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message);
    }

    // 3. ë¡œê·¸ì¸ í›„ activate ì‹¤í–‰
    window.addEventListener("load", async () => {
      // localStorageì—ì„œ í‚¤ ë³µêµ¬
      const savedKey = localStorage.getItem("licenseKey");
      const validFlag = localStorage.getItem("licenseKeyValid") === "true";
      if (savedKey) {
        currentLicenseKey = savedKey;
        licenseKeyValid = validFlag;
        document.getElementById("licenseKey").value = savedKey;
        if (validFlag) document.getElementById("loginBtn").disabled = false;
      }

      const { data } = await supabase.auth.getSession();
      const session = data.session;

      // âœ… ì„¸ì…˜+í‚¤+ê²€ì¦ ì„±ê³µ â†’ activate
      if (session && currentLicenseKey && licenseKeyValid) {
        await activateLicense(session, currentLicenseKey);
      }
    });

    // activate í•¨ìˆ˜
    async function activateLicense(session, key) {
      const res = await fetch(`${SUPABASE_URL}/functions/v1/activate`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": SUPABASE_ANON_KEY,
          "Authorization": `Bearer ${session.access_token}`
        },
        body: JSON.stringify({ license_key: key })
      });
      const dataRes = await res.json();

      if (dataRes.ok) {
        const { data: refreshed } = await supabase.auth.refreshSession();
        const newSession = refreshed.session;

        const entRes = await fetch(`${SUPABASE_URL}/functions/v1/entitlement`, {
          headers: {
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": `Bearer ${newSession.access_token}`
          }
        });
        const ent = await entRes.json();

        if (ent.valid) {
          startCountdown();
        } else {
          setStatus("âŒ ë¼ì´ì„ ìŠ¤ ë“±ë¡ì€ ë˜ì—ˆìœ¼ë‚˜ í™œì„±í™”ê°€ ë°˜ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
        }
      } else {
        setStatus("âŒ ë¼ì´ì„ ìŠ¤ ë“±ë¡ ì‹¤íŒ¨: " + JSON.stringify(dataRes));
      }
    }

    // ì¸ì¦ ì™„ë£Œ í›„ ì¹´ìš´íŠ¸ë‹¤ìš´
    function startCountdown() {
      let count = 10;
      setStatus(`âœ… ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
ì´ì œ GPT ì°½ìœ¼ë¡œ ëŒì•„ê°€ì„¸ìš”.
ğŸ‘‰ GPT ì°½ì—ì„œ "ì‹œì‘í•˜ê¸°" ê°™ì€ ì•„ë¬´ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ë©´ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.

ì´ ì°½ì€ ${count}ì´ˆ í›„ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤... (${count})`);
      document.getElementById("closeBtn").style.display = "inline-block";

      const interval = setInterval(() => {
        count--;
        if (count > 0) {
          setStatus(`âœ… ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
ì´ì œ GPT ì°½ìœ¼ë¡œ ëŒì•„ê°€ì„¸ìš”.
ğŸ‘‰ GPT ì°½ì—ì„œ "ì‹œì‘í•˜ê¸°" ê°™ì€ ì•„ë¬´ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ë©´ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.

ì´ ì°½ì€ ${count}ì´ˆ í›„ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤... (${count})`);
        } else {
          clearInterval(interval);
          window.close();
        }
      }, 1000);
    }

    function setStatus(msg) {
      document.getElementById("status").innerText = msg;
    }
  </script>
</body>
</html>
