<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>라이선스 인증 및 로그인</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 2rem; max-width: 720px; margin: auto; }
    h1 { margin: 0 0 1rem; }
    .card { border: 1px solid #eee; border-radius: 12px; padding: 1rem 1.25rem; margin: 1rem 0; }
    input[type="text"] { width: 100%; padding: .6rem .8rem; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 1rem; }
    button { padding: .6rem 1rem; border-radius: 8px; border: none; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    #status { margin-top: 1rem; font-weight: bold; white-space: pre-line; }
  </style>
</head>
<body>
  <h1>🔑 라이선스 인증 및 로그인</h1>

  <div class="card">
    <label>라이선스 키 입력:</label>
    <input type="text" id="licenseKey" placeholder="구매 시 받은 라이선스 키 입력" />
    <button id="activateBtn">1️⃣ 라이선스 등록</button>
  </div>

  <div class="card">
    <p>이미 라이선스 키를 등록하셨다면, 아래 버튼으로 로그인만 진행하세요.</p>
    <button id="loginBtn" disabled>2️⃣ Google 로그인</button>
  </div>

  <div id="status"></div>
  <button id="closeBtn">❌ 창 닫기</button>

  <script>
    const SUPABASE_URL = "https://kwjxtfyzerwynwqnbpjk.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3anh0Znl6ZXJ3eW53cW5icGprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNzUyOTAsImV4cCI6MjA3Mzc1MTI5MH0.ykrO0pTt6dK56pXPmvcnNdWSm894n1tvNPMvE4ZbgwI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const licenseInput = document.getElementById("licenseKey");
    const activateBtn = document.getElementById("activateBtn");
    const loginBtn = document.getElementById("loginBtn");
    const closeBtn = document.getElementById("closeBtn");

    activateBtn.onclick = async () => {
      const key = licenseInput.value.trim();
      if (!key) return setStatus("❌ 라이선스 키를 입력해 주세요.");

      setStatus("⏳ 라이선스 등록 중...");
      const { data, error } = await fetch(`${SUPABASE_URL}/functions/v1/activate`, {
        method: "POST",
        headers: { "Content-Type": "application/json", apikey: SUPABASE_ANON_KEY },
        body: JSON.stringify({ license_key: key })
      }).then(r => r.json());

      if (data?.ok) {
        setStatus("✅ 라이선스 등록이 완료되었습니다.\n이제 2️⃣ 로그인 버튼을 눌러 주세요.");
        loginBtn.disabled = false;
      } else {
        setStatus("❌ 라이선스 등록 실패: " + (error?.message || data?.reason || "알 수 없는 오류"));
      }
    };

    loginBtn.onclick = async () => {
      setStatus("⏳ Google 로그인 진행 중...");
      const { data, error } = await supabase.auth.signInWithOAuth({ provider: "google" });

      if (error) {
        setStatus("❌ 로그인 오류: " + error.message);
        return;
      }

      // OAuth 리다이렉트 후 세션 감지
      supabase.auth.onAuthStateChange(async (event, session) => {
        if (session) {
          setStatus("⏳ 인증 확인 중...");
          const entRes = await fetch(`${SUPABASE_URL}/functions/v1/entitlement`, {
            headers: {
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${session.access_token}`
            }
          });
          const ent = await entRes.json();

          if (ent.valid) {
            let countdown = 10;
            setStatus(`✅ 인증이 완료되었습니다!\n${countdown}초 후 창이 닫힙니다...`);

            const interval = setInterval(() => {
              countdown--;
              if (countdown <= 0) {
                clearInterval(interval);
                window.close();
              } else {
                setStatus(`✅ 인증이 완료되었습니다!
                이제 GPT 창으로 돌아가세요.
                👉 GPT 창에서 "시작하기" 같은 아무 메시지를 입력하면
                자동으로 인증이 갱신되고 바로 사용 가능합니다.
                \n${countdown}초 후 창이 닫힙니다...`);
              }
            }, 1000);
          } else {
            setStatus("❌ 라이선스가 확인되지 않았습니다. 다시 시도해 주세요.");
          }
        }
      });
    };

    closeBtn.onclick = () => window.close();

    function setStatus(msg) {
      document.getElementById("status").innerText = msg;
    }
  </script>
</body>
</html>
