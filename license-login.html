<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë¼ì´ì„ ìŠ¤ ì¸ì¦ ë° ë¡œê·¸ì¸</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 2rem; max-width: 720px; margin: auto; }
    h1 { margin: 0 0 1rem; }
    .card { border: 1px solid #eee; border-radius: 12px; padding: 1rem 1.25rem; margin: 1rem 0; }
    input[type="text"] { width: 100%; padding: .6rem .8rem; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 1rem; }
    button { padding: .6rem 1rem; border-radius: 8px; border: none; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    #status { margin-top: 1rem; font-weight: bold; white-space: pre-line; }
  </style>
</head>
<body>
  <h1>ğŸ”‘ ë¼ì´ì„ ìŠ¤ ì¸ì¦ ë° ë¡œê·¸ì¸</h1>

  <div class="card">
    <label>ë¼ì´ì„ ìŠ¤ í‚¤ ì…ë ¥:</label>
    <input type="text" id="licenseKey" placeholder="êµ¬ë§¤ ì‹œ ë°›ì€ ë¼ì´ì„ ìŠ¤ í‚¤ ì…ë ¥" />
    <button id="activateBtn">1ï¸âƒ£ ë¼ì´ì„ ìŠ¤ ë“±ë¡</button>
  </div>

  <div class="card">
    <p>ì´ë¯¸ ë¼ì´ì„ ìŠ¤ í‚¤ë¥¼ ë“±ë¡í•˜ì…¨ë‹¤ë©´, ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ë¡œê·¸ì¸ë§Œ ì§„í–‰í•˜ì„¸ìš”.</p>
    <button id="loginBtn" disabled>2ï¸âƒ£ Google ë¡œê·¸ì¸</button>
  </div>

  <div id="status"></div>
  <button id="closeBtn">âŒ ì°½ ë‹«ê¸°</button>

  <script>
    const SUPABASE_URL = "https://kwjxtfyzerwynwqnbpjk.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3anh0Znl6ZXJ3eW53cW5icGprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNzUyOTAsImV4cCI6MjA3Mzc1MTI5MH0.ykrO0pTt6dK56pXPmvcnNdWSm894n1tvNPMvE4ZbgwI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const licenseInput = document.getElementById("licenseKey");
    const activateBtn = document.getElementById("activateBtn");
    const loginBtn = document.getElementById("loginBtn");
    const closeBtn = document.getElementById("closeBtn");

    activateBtn.onclick = async () => {
      const key = licenseInput.value.trim();
      if (!key) return setStatus("âŒ ë¼ì´ì„ ìŠ¤ í‚¤ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");

      setStatus("â³ ë¼ì´ì„ ìŠ¤ ë“±ë¡ ì¤‘...");
      const { data, error } = await fetch(`${SUPABASE_URL}/functions/v1/activate`, {
        method: "POST",
        headers: { "Content-Type": "application/json", apikey: SUPABASE_ANON_KEY },
        body: JSON.stringify({ license_key: key })
      }).then(r => r.json());

      if (data?.ok) {
        setStatus("âœ… ë¼ì´ì„ ìŠ¤ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nì´ì œ 2ï¸âƒ£ ë¡œê·¸ì¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.");
        loginBtn.disabled = false;
      } else {
        setStatus("âŒ ë¼ì´ì„ ìŠ¤ ë“±ë¡ ì‹¤íŒ¨: " + (error?.message || data?.reason || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
      }
    };

    loginBtn.onclick = async () => {
      setStatus("â³ Google ë¡œê·¸ì¸ ì§„í–‰ ì¤‘...");
      const { data, error } = await supabase.auth.signInWithOAuth({ provider: "google" });

      if (error) {
        setStatus("âŒ ë¡œê·¸ì¸ ì˜¤ë¥˜: " + error.message);
        return;
      }

      // OAuth ë¦¬ë‹¤ì´ë ‰íŠ¸ í›„ ì„¸ì…˜ ê°ì§€
      supabase.auth.onAuthStateChange(async (event, session) => {
        if (session) {
          setStatus("â³ ì¸ì¦ í™•ì¸ ì¤‘...");
          const entRes = await fetch(`${SUPABASE_URL}/functions/v1/entitlement`, {
            headers: {
              apikey: SUPABASE_ANON_KEY,
              Authorization: `Bearer ${session.access_token}`
            }
          });
          const ent = await entRes.json();

          if (ent.valid) {
            let countdown = 10;
            setStatus(`âœ… ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n${countdown}ì´ˆ í›„ ì°½ì´ ë‹«í™ë‹ˆë‹¤...`);

            const interval = setInterval(() => {
              countdown--;
              if (countdown <= 0) {
                clearInterval(interval);
                window.close();
              } else {
                setStatus(`âœ… ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
                ì´ì œ GPT ì°½ìœ¼ë¡œ ëŒì•„ê°€ì„¸ìš”.
                ğŸ‘‰ GPT ì°½ì—ì„œ "ì‹œì‘í•˜ê¸°" ê°™ì€ ì•„ë¬´ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ë©´
                ìë™ìœ¼ë¡œ ì¸ì¦ì´ ê°±ì‹ ë˜ê³  ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
                \n${countdown}ì´ˆ í›„ ì°½ì´ ë‹«í™ë‹ˆë‹¤...`);
              }
            }, 1000);
          } else {
            setStatus("âŒ ë¼ì´ì„ ìŠ¤ê°€ í™•ì¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
          }
        }
      });
    };

    closeBtn.onclick = () => window.close();

    function setStatus(msg) {
      document.getElementById("status").innerText = msg;
    }
  </script>
</body>
</html>
