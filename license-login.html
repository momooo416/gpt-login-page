<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>GPT ë¼ì´ì„ ìŠ¤ ì¸ì¦</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      padding: 2rem;
      max-width: 480px;
      margin: auto;
    }
    h1 { margin-bottom: 1rem; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 1rem; margin: 1rem 0; }
    input, button { padding: .6rem .8rem; border-radius: 8px; border: 1px solid #ccc; margin-top: .5rem; width: 100%; }
    button { background: #4CAF50; color: white; cursor: pointer; border: none; }
    button:hover { background: #45a049; }
    #status { margin-top: 1rem; font-weight: bold; }
    #gpt-return { display: none; margin-top: 1rem; background: #2196F3; }
  </style>
</head>
<body>
  <h1>GPT ë¼ì´ì„ ìŠ¤ ì¸ì¦</h1>

  <div class="card">
    <label>ë¼ì´ì„ ìŠ¤ í‚¤</label>
    <input type="text" id="licenseKey" placeholder="ë¼ì´ì„ ìŠ¤ í‚¤ ì…ë ¥" />
    <button onclick="checkLicense()">1. í‚¤ í™•ì¸</button>
  </div>

  <div class="card">
    <button onclick="loginWithGoogle()">2. Google ë¡œê·¸ì¸</button>
  </div>

  <div class="card">
    <button onclick="activateKey()">3. ê¶Œí•œ í™•ì¸ (í‚¤ í™œì„±í™”)</button>
  </div>

  <p id="status"></p>
  <button id="gpt-return" onclick="goBackToGPT()">âœ… GPTë¡œ ëŒì•„ê°€ê¸°</button>

  <script>
    const SUPABASE_URL = "https://kwjxtfyzerwynwqnbpjk.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3anh0Znl6ZXJ3eW53cW5icGprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNzUyOTAsImV4cCI6MjA3Mzc1MTI5MH0.ykrO0pTt6dK56pXPmvcnNdWSm894n1tvNPMvE4ZbgwI"; // Supabase â†’ Project settings â†’ API â†’ anon key
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentLicenseKey = "";

    // 1. ë¼ì´ì„ ìŠ¤ í‚¤ í™•ì¸
    async function checkLicense() {
      const key = document.getElementById("licenseKey").value.trim();
      if (!key) return setStatus("âŒ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      const res = await fetch(`${SUPABASE_URL}/functions/v1/license-precheck`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "apikey": SUPABASE_ANON_KEY },
        body: JSON.stringify({ license_key: key })
      });
      const data = await res.json();
      if (data.valid) {
        currentLicenseKey = key;
        setStatus("âœ… í‚¤ í™•ì¸ ì™„ë£Œ. ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•˜ì„¸ìš”.");
      } else {
        setStatus("âŒ ì˜ëª»ëœ í‚¤ê±°ë‚˜ ì´ë¯¸ ì‚¬ìš©ëœ í‚¤ì…ë‹ˆë‹¤.");
      }
    }

    // 2. Google ë¡œê·¸ì¸
    async function loginWithGoogle() {
      const { data, error } = await supabase.auth.signInWithOAuth({
        provider: "google",
        options: {
          redirectTo: window.location.href
        }
      });
      if (error) setStatus("âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message);
      else setStatus("âœ… Google ë¡œê·¸ì¸ ì§„í–‰ ì¤‘...");
    }

    // 3. í‚¤ í™œì„±í™”
    async function activateKey() {
      if (!currentLicenseKey) return setStatus("âŒ ë¨¼ì € í‚¤ í™•ì¸ì„ í•´ì£¼ì„¸ìš”.");

      const session = (await supabase.auth.getSession()).data.session;
      if (!session) return setStatus("âŒ ë¡œê·¸ì¸ ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤. Google ë¡œê·¸ì¸ ë¨¼ì € í•˜ì„¸ìš”.");

      const res = await fetch(`${SUPABASE_URL}/functions/v1/activate`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": SUPABASE_ANON_KEY,
          "Authorization": `Bearer ${session.access_token}`
        },
        body: JSON.stringify({ license_key: currentLicenseKey })
      });
      const data = await res.json();

      if (data.ok) {
        // í™œì„±í™” í›„ entitlement í™•ì¸
        const entRes = await fetch(`${SUPABASE_URL}/functions/v1/entitlement`, {
          headers: {
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": `Bearer ${session.access_token}`
          }
        });
        const ent = await entRes.json();

        if (ent.valid) {
          setStatus("âœ… ê¶Œí•œ í™•ì¸ ì™„ë£Œ! GPT ì‚¬ìš©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
          document.getElementById("gpt-return").style.display = "block";
        } else {
          setStatus("âŒ ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        }
      } else {
        setStatus("âŒ í‚¤ í™œì„±í™” ì‹¤íŒ¨: " + (data.reason || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
      }
    }

    // 4. GPTë¡œ ëŒì•„ê°€ê¸° (ìˆ˜ë™ ë²„íŠ¼)
    function goBackToGPT() {
      window.location.href = "https://chatgpt.com/g/g-68c117eac37c8191b303c4d8746d4d56-seutog-yoso-jejag-gpt"; // ğŸ‘‰ ì—¬ê¸°ì— ë„¤ Custom GPT ë§í¬ ë„£ê¸°
    }

    function setStatus(msg) {
      document.getElementById("status").innerText = msg;
    }
  </script>
</body>
</html>
