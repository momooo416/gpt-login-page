<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>요소 제작봇GPT 라이선스 인증</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      padding: 2rem;
      max-width: 480px;
      margin: auto;
      text-align: center;
    }
    h1 { margin-bottom: 1rem; }
    .step { margin: 1rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 12px; }
    input, button {
      padding: .7rem 1rem; border-radius: 8px; border: 1px solid #ccc; width: 100%; margin-top: .5rem;
    }
    button {
      background: #4CAF50; color: white; cursor: pointer; border: none; font-size: 1rem;
    }
    button:hover { background: #45a049; }
    #status { margin-top: 1rem; font-weight: bold; }
    #logoutBtn { background:#e74c3c; margin-top:1rem; display:none; }  /* 🚨 (수정) 로그아웃 버튼 스타일 추가 */
    #logoutBtn:hover { background:#c0392b; }
  </style>
</head>
<body>
  <h1>GPT 라이선스 인증</h1>

  <!-- Step 1 -->
  <div class="step">
    <label>라이선스 키</label>
    <input type="text" id="licenseKey" placeholder="구매 후 받은 키를 입력하세요" />
    <button onclick="checkLicense()">1. 키 확인</button>
  </div>

  <!-- Step 2 -->
  <div class="step">
    <button id="loginBtn" onclick="loginWithGoogle()" disabled>
      2. Google 로그인
    </button>
    <p id="loginHint" style="font-size:0.9rem; color:#666;"></p>
  </div>
  <!-- Step 3: 로그아웃 버튼 -->
  <div class="step">
    <button id="logoutBtn" onclick="logout()">로그아웃</button> <!-- 🚨 (수정) 로그아웃 버튼 추가 -->
  </div>
  
  <p id="status"></p>
  <button id="closeBtn" style="display:none; margin-top:1rem;" onclick="window.close()">창 닫기</button>


  <script>
    const SUPABASE_URL = "https://kwjxtfyzerwynwqnbpjk.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3anh0Znl6ZXJ3eW53cW5icGprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNzUyOTAsImV4cCI6MjA3Mzc1MTI5MH0.ykrO0pTt6dK56pXPmvcnNdWSm894n1tvNPMvE4ZbgwI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentLicenseKey = "";
    let closeCountdown;

    // 페이지 로드 시 localStorage에서 키 불러오기
    window.addEventListener("load", async () => {
      const savedKey = localStorage.getItem("licenseKey");
      if (savedKey) {
        document.getElementById("licenseKey").value = savedKey;
        currentLicenseKey = savedKey;
        document.getElementById("loginBtn").disabled = false;
        document.getElementById("loginHint").innerText = "이미 키가 등록된 경우, 로그인 버튼을 눌러주세요.";
        setStatus("ℹ️ 저장된 키 확인완료. 로그인 버튼을 눌러주세요.");
      }

      // 🚨 (수정) 로그인 세션 확인 → 로그인 중이면 로그아웃 버튼 표시
      const session = (await supabase.auth.getSession()).data.session;
      if (session) {
        document.getElementById("logoutBtn").style.display = "inline-block";
        setStatus("✅ 이미 로그인된 상태입니다. 필요하면 로그아웃 후 다른 계정으로 로그인하세요.");
      }
    });


    // 1. 라이선스 키 확인
    async function checkLicense() {
      const key = document.getElementById("licenseKey").value.trim();
      if (!key) return setStatus("❌ 키를 입력해주세요.");

      setStatus("🔄 라이선스 확인 중...");
      const res = await fetch(`${SUPABASE_URL}/functions/v1/license-precheck`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "apikey": SUPABASE_ANON_KEY },
        body: JSON.stringify({ license_key: key })
      });
      const data = await res.json();

      // 🚨 (수정) 상태별 안내 멘트 분기
      if (data.status === "issued") {
        setStatus("✅ 사용 가능한 라이선스 키입니다.\n👉 Google 로그인을 진행해서 등록을 완료해주세요.");
        currentLicenseKey = key;
        localStorage.setItem("licenseKey", key);
        document.getElementById("loginBtn").disabled = false;

      } else if (data.status === "active") {
        setStatus("✅ 이미 등록된 라이선스 키입니다.\n👉 Google 로그인을 진행해서 계정 확인을 완료해주세요.");
        currentLicenseKey = key;
        localStorage.setItem("licenseKey", key);
        document.getElementById("loginBtn").disabled = false;

      } else if (data.status === "expired") {
        setStatus("⏰ 만료된 라이선스 키입니다. 새로 구매해 주세요.");
        document.getElementById("loginBtn").disabled = true;

      } else {
        setStatus("❌ 올바르지 않은 라이선스 키입니다.");
        document.getElementById("loginBtn").disabled = true;
      }
    }

    // 2. Google 로그인
    async function loginWithGoogle() {
      if (!currentLicenseKey) {
        return setStatus("❌ 먼저 라이선스 키를 등록하세요.");
      }
       setStatus("⏳ Google 로그인 진행 중...");      
      const { error } = await supabase.auth.signInWithOAuth({
        provider: "google",
        options: { 
          redirectTo: window.location.href,
          queryParams: { prompt: "select_account" } // 🚨 항상 계정 선택창 뜨도록 설정
        }
      });
      if (error) setStatus("❌ 로그인 실패: " + error.message);
    }

    // 3. 로그아웃 🚨 (수정) 로그아웃 기능 추가
    async function logout() {
      const { error } = await supabase.auth.signOut();
      if (error) {
        setStatus("❌ 로그아웃 실패: " + error.message);
      } else {
        setStatus("👋 로그아웃 되었습니다. 다른 계정으로 다시 로그인할 수 있습니다.");
        document.getElementById("loginBtn").disabled = false;
        document.getElementById("logoutBtn").style.display = "none";
        localStorage.removeItem("licenseKey"); // 🚨 저장된 키도 제거 (선택사항)
        currentLicenseKey = "";
      }
    }

    // 로그인 후 자동 권한 확인
    window.addEventListener("load", async () => {
      const session = (await supabase.auth.getSession()).data.session;
      if (session) {
         setStatus("⏳ 라이선스 활성화 중...");
      
        const res = await fetch(`${SUPABASE_URL}/functions/v1/activate`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "apikey": SUPABASE_ANON_KEY,
            "Authorization": `Bearer ${session.access_token}`
          },
          body: JSON.stringify({ license_key: currentLicenseKey })
        });
        const data = await res.json();

        if (data.ok) {
          // entitlement 확인
          const entRes = await fetch(`${SUPABASE_URL}/functions/v1/entitlement`, {
            headers: {
              "apikey": SUPABASE_ANON_KEY,
              "Authorization": `Bearer ${session.access_token}`
            }
          });
          const ent = await entRes.json();
          if (ent.valid) {
            let countdown = 10;
            setStatus(`✅ 인증이 완료되었습니다!
            👉 GPT 창에서 "시작하기" 같은 아무 메시지를 입력하면
            자동으로 인증이 갱신되고 바로 사용 가능합니다.
            \n${countdown}초 후 창이 닫힙니다...`);

          document.getElementById("closeBtn").style.display = "inline-block";
          document.getElementById("logoutBtn").style.display = "inline-block"; // 🚨 로그인 완료 후 로그아웃 버튼 표시

            const interval = setInterval(() => {
              countdown--;
              if (countdown <= 0) {
                clearInterval(interval);
                window.close();
              } else {
                setStatus(`✅ 인증이 완료되었습니다!
                👉 GPT 창에서 "시작하기" 같은 아무 메시지를 입력하면
                자동으로 인증이 갱신되고 바로 사용 가능합니다.
                \n${countdown}초 후 창이 닫힙니다...`);
              }
            }, 1000);
          } else {
            setStatus("❌ 라이선스가 확인되지 않았습니다. 다시 시도해 주세요.");
          }

        } else {
          // 🚨 (수정) activate 응답 reason별 분기 처리
          if (data.reason === "already_registered_to_other") {
            setStatus("⚠️ 이 라이선스는 다른 계정에 이미 등록되어 있습니다.");
          } else if (data.reason === "expired") {
            setStatus("⏰ 만료된 라이선스입니다. 새로 구매해 주세요.");
          } else if (data.reason === "not_found") {
            setStatus("❌ 라이선스 키를 찾을 수 없습니다.");
          } else {
            setStatus("❌ 라이선스 활성화 실패. 다시 시도해 주세요.");
          }
        }
      }
    });

    function setStatus(msg) {
      document.getElementById("status").innerText = msg;
    }
  </script>
</body>
</html>
